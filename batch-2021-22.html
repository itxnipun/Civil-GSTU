<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch 2021-22 - Dept. of Civil Engineering</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Additional styles for editable cards */
        .profile-card {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .profile-card.editable {
            border: 2px solid #4CAF50;
            background-color: #f8fff8;
        }
        
        .edit-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        
        .profile-card.editing .profile-link {
            pointer-events: none; /* Disable link when editing */
        }
        
        .edit-form {
            display: none;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .edit-form.active {
            display: block;
        }
        
        .edit-form input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-buttons {
            margin-top: 15px;
            text-align: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 0 5px;
            transition: background-color 0.2s;
        }
        
        .btn-edit {
            background: #2196F3;
            color: white;
        }
        
        .btn-edit:hover {
            background: #1976D2;
        }
        
        .btn-save {
            background: #4CAF50;
            color: white;
        }
        
        .btn-save:hover {
            background: #45a049;
        }
        
        .btn-cancel {
            background: #f44336;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #d32f2f;
        }
        
        .btn-view {
            background: #FF9800;
            color: white;
        }
        
        .btn-view:hover {
            background: #F57C00;
        }
        
        .current-user-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .login-prompt {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 4px solid #ffc107;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">
            <img src="images/logo.png" alt="Department of Civil Engineering Logo">
        </a>
        <ul class="nav-links" id="main-nav-links"></ul>
    </nav>
    
    <div class="container">
        <div class="page-header">
            <h1>Students of Session 2021-22</h1>
        </div>
        
        <!-- Current User Display -->
        <div id="current-user-display"></div>
        
        <div class="tab-nav">
            <a href="#" class="tab-link active" onclick="showTab(event, 'students')">Student List</a>
            <a href="#" class="tab-link" onclick="showTab(event, 'advisor')">Batch Advisor</a>
            <a href="#" class="tab-link" onclick="showTab(event, 'schedule')">Class Schedule</a>
            <a href="#" class="tab-link" onclick="showTab(event, 'contents')">Class Contents</a>
        </div>
        
        <div id="students" class="tab-content active">
            <h2>Full Student List</h2>
            <div id="messages"></div>
            <div class="profile-grid" id="student-grid">
                <p>Loading students...</p>
            </div>
        </div>
        
        <div id="advisor" class="tab-content">
            <h2>Batch Advisor</h2>
            <div class="profile-card" style="max-width: 350px; margin: auto;">
                <img src="images/md-mahmudun-nabi.jpg" alt="Photo of Batch Advisor">
                <h3>Md. Mahmudun Nabi</h3>
                <p class="title">Batch Advisor</p>
            </div>
        </div>
        
        <div id="schedule" class="tab-content">
            <h2>Class Schedule (Routine)</h2>
            <p style="text-align:center;">Schedule for this batch will be updated soon.</p>
        </div>
        
        <div id="contents" class="tab-content">
            <h2>Class Contents & Resources</h2>
            <p style="text-align:center;">Resources for this batch will be uploaded soon.</p>
        </div>
    </div>
    
    <footer class="footer">
        <p>&copy; 2025 Department of Civil Engineering, Gopalganj Science and Technology University</p>
        <p>Gopalganj-8105, Bangladesh</p>
    </footer>

    <script src="auth.js"></script>
    <script src="auth-guard.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let editingStates = {};

        // Tab functionality
        function showTab(event, tabName) {
            event.preventDefault();
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { 
                tabcontent[i].classList.remove("active"); 
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) { 
                tablinks[i].classList.remove("active"); 
            }
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }

        // Check authentication and get current user
        async function checkCurrentUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session && session.user) {
                // Get the student profile for this user
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single();
                
                if (profile && !error) {
                    currentUser = {
                        id: session.user.id,
                        student_id: profile.student_id,
                        full_name: profile.full_name,
                        email: profile.email
                    };
                    updateUserDisplay();
                } else {
                    showLoginPrompt();
                }
            } else {
                showLoginPrompt();
            }
        }

        // Update user display
        function updateUserDisplay() {
            const displayDiv = document.getElementById('current-user-display');
            if (currentUser) {
                displayDiv.innerHTML = `
                    <div class="current-user-info">
                        <strong>Logged in as:</strong> ${currentUser.full_name} (${currentUser.student_id})
                        <br>
                        <small>You can edit your profile in the list below</small>
                    </div>
                `;
            } else {
                displayDiv.innerHTML = '';
            }
        }

        // Show login prompt
        function showLoginPrompt() {
            const displayDiv = document.getElementById('current-user-display');
            displayDiv.innerHTML = `
                <div class="login-prompt">
                    <strong>Want to edit your profile?</strong> 
                    <a href="login.html" style="color: #856404; font-weight: bold;">Login here</a> 
                    to edit your information directly from this list.
                </div>
            `;
        }

        // Load students
        async function loadStudents() {
            const special20CE_IDs = ['20CE011', '20CE021', '20CE025', '20CE036'];
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .or(`and(student_id.like.21CE%,student_id.not.eq.21CE032),student_id.in.(${special20CE_IDs.join(',')})`)
                    .order('student_id');

                if (error) throw error;

                students = data || [];
                displayStudents();
            } catch (error) {
                console.error('Error fetching students:', error);
                document.getElementById('student-grid').innerHTML = '<p>Could not load student data.</p>';
            }
        }

        // Display students
        function displayStudents() {
            const studentGrid = document.getElementById('student-grid');
            
            if (students.length === 0) {
                studentGrid.innerHTML = '<p>No students found for this session.</p>';
                return;
            }

            studentGrid.innerHTML = '';
            
            students.forEach(student => {
                const isEditable = currentUser && currentUser.student_id === student.student_id;
                const isEditing = editingStates[student.student_id];

                const cardDiv = document.createElement('div');
                cardDiv.className = `profile-card ${isEditable ? 'editable' : ''} ${isEditing ? 'editing' : ''}`;
                cardDiv.innerHTML = `
                    ${isEditable ? '<div class="edit-badge">Your Profile</div>' : ''}
                    
                    <a href="profile.html?id=${student.student_id}" class="profile-link" style="text-decoration: none; color: inherit; display: block;">
                        <img loading="lazy" src="${student.avatar_url || `https://placehold.co/400x400/cccccc/333333/png?text=${student.student_id}`}" alt="Photo of ${student.full_name}">
                        <h3>${student.full_name}</h3>
                        <p><strong>Student ID:</strong> ${student.student_id}</p>
                        <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                        <p><strong>Number:</strong> ${student.phone_number || 'N/A'}</p>
                    </a>
                    
                    ${isEditable ? `
                        <div class="edit-buttons">
                            ${!isEditing ? `
                                <button onclick="editStudent('${student.student_id}')" class="btn btn-edit">Quick Edit</button>
                                <a href="profile.html?id=${student.student_id}" class="btn btn-view">Full Profile</a>
                            ` : ''}
                        </div>
                        
                        <div class="edit-form ${isEditing ? 'active' : ''}" id="edit-form-${student.student_id}">
                            <h4>Edit Your Profile</h4>
                            <input type="text" id="edit-name-${student.student_id}" placeholder="Full Name" value="${student.full_name || ''}">
                            <input type="email" id="edit-email-${student.student_id}" placeholder="Email" value="${student.email || ''}">
                            <input type="tel" id="edit-phone-${student.student_id}" placeholder="Phone Number" value="${student.phone_number || ''}">
                            <div class="edit-buttons">
                                <button onclick="saveStudent('${student.student_id}')" class="btn btn-save">Save Changes</button>
                                <button onclick="cancelEdit('${student.student_id}')" class="btn btn-cancel">Cancel</button>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                studentGrid.appendChild(cardDiv);
            });
        }

        // Edit student
        function editStudent(studentId) {
            editingStates[studentId] = true;
            displayStudents();
        }

        // Cancel edit
        function cancelEdit(studentId) {
            delete editingStates[studentId];
            displayStudents();
            showMessage('Edit cancelled', 'info');
        }

        // Save student
        async function saveStudent(studentId) {
            const student = students.find(s => s.student_id === studentId);
            if (!student) return;

            const updatedData = {
                full_name: document.getElementById(`edit-name-${studentId}`).value.trim(),
                email: document.getElementById(`edit-email-${studentId}`).value.trim(),
                phone_number: document.getElementById(`edit-phone-${studentId}`).value.trim()
            };

            // Validate required fields
            if (!updatedData.full_name) {
                showMessage('Name is required', 'error');
                return;
            }

            if (!updatedData.email) {
                showMessage('Email is required', 'error');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .update(updatedData)
                    .eq('student_id', studentId)
                    .select()
                    .single();

                if (error) throw error;

                // Update local data
                const studentIndex = students.findIndex(s => s.student_id === studentId);
                if (studentIndex !== -1) {
                    students[studentIndex] = { ...students[studentIndex], ...updatedData };
                }

                delete editingStates[studentId];
                displayStudents();
                showMessage('Profile updated successfully!', 'success');

            } catch (error) {
                console.error('Error updating profile:', error);
                showMessage('Error updating profile: ' + error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageClass = type === 'success' ? 'success-message' : 
                               type === 'error' ? 'error-message' : 'info-message';
            
            messagesDiv.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Initialize page
        async function initializePage() {
            await checkCurrentUser();
            await loadStudents();
        }

        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                setTimeout(() => {
                    initializePage();
                }, 100);
            }
        });

        // Start the page
        initializePage();
    </script>
</body>
</html>
