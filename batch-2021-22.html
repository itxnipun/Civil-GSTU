<script src="auth.js"></script>
    <script src="auth-guard.js"></script>
    <script>
        // Initialize Supabase (ADD THIS - MISSING IN YOUR CODE)
        const SUPABASE_URL = 'https://cwubbhcuormtrvyczgpf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3dWJiaGN1b3JtdHJ2eWN6Z3BmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MDQ2MDIsImV4cCI6MjA3Mjk4MDYwMn0.EC-lF_wgrTZxvBpHb_z___45JGHHwX3hKGgQ3juRy5I';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentUser = null;
        let students = [];
        let editingStates = {};

        // Tab functionality
        function showTab(event, tabName) {
            event.preventDefault();
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { 
                tabcontent[i].classList.remove("active"); 
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) { 
                tablinks[i].classList.remove("active"); 
            }
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.classList.add("active");
        }

        // Check authentication and get current user
        async function checkCurrentUser() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session && session.user) {
                    // Get the student profile for this user
                    const { data: profile, error } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('user_id', session.user.id)
                        .single();
                    
                    if (profile && !error) {
                        currentUser = {
                            id: session.user.id,
                            student_id: profile.student_id,
                            full_name: profile.full_name,
                            email: profile.email
                        };
                        console.log('Current user:', currentUser);
                        updateUserDisplay();
                    } else {
                        console.log('No profile found for user');
                        showLoginPrompt();
                    }
                } else {
                    console.log('No authenticated user');
                    showLoginPrompt();
                }
            } catch (error) {
                console.error('Error checking current user:', error);
                showLoginPrompt();
            }
        }

        // Update user display
        function updateUserDisplay() {
            const displayDiv = document.getElementById('current-user-display');
            if (currentUser) {
                displayDiv.innerHTML = `
                    <div class="current-user-info">
                        <strong>Logged in as:</strong> ${currentUser.full_name} (${currentUser.student_id})
                        <br>
                        <small>You can edit your profile in the list below</small>
                    </div>
                `;
            } else {
                displayDiv.innerHTML = '';
            }
        }

        // Show login prompt
        function showLoginPrompt() {
            const displayDiv = document.getElementById('current-user-display');
            displayDiv.innerHTML = `
                <div class="login-prompt">
                    <strong>Want to edit your profile?</strong> 
                    <a href="login.html" style="color: #856404; font-weight: bold;">Login here</a> 
                    to edit your information directly from this list.
                </div>
            `;
        }

        // Load students
        async function loadStudents() {
            const special20CE_IDs = ['20CE011', '20CE021', '20CE025', '20CE036'];
            
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .or(`and(student_id.like.21CE%,student_id.not.eq.21CE032),student_id.in.(${special20CE_IDs.join(',')})`)
                    .order('student_id');

                if (error) throw error;

                students = data || [];
                console.log('Loaded students:', students.length);
                displayStudents();
            } catch (error) {
                console.error('Error fetching students:', error);
                document.getElementById('student-grid').innerHTML = '<p>Could not load student data.</p>';
            }
        }

        // Display students
        function displayStudents() {
            const studentGrid = document.getElementById('student-grid');
            
            if (students.length === 0) {
                studentGrid.innerHTML = '<p>No students found for this session.</p>';
                return;
            }

            studentGrid.innerHTML = '';
            
            students.forEach(student => {
                const isEditable = currentUser && currentUser.student_id === student.student_id;
                const isEditing = editingStates[student.student_id];

                const cardDiv = document.createElement('div');
                cardDiv.className = `profile-card ${isEditable ? 'editable' : ''} ${isEditing ? 'editing' : ''}`;
                cardDiv.innerHTML = `
                    ${isEditable ? '<div class="edit-badge">Your Profile</div>' : ''}
                    
                    <a href="profile.html?id=${student.student_id}" class="profile-link" style="text-decoration: none; color: inherit; display: block;">
                        <img loading="lazy" src="${student.avatar_url || `https://placehold.co/400x400/cccccc/333333/png?text=${student.student_id}`}" alt="Photo of ${student.full_name}" onerror="this.src='https://placehold.co/400x400/cccccc/333333/png?text=${student.student_id}'">
                        <h3>${student.full_name}</h3>
                        <p><strong>Student ID:</strong> ${student.student_id}</p>
                        <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                        <p><strong>Number:</strong> ${student.phone_number || 'N/A'}</p>
                    </a>
                    
                    ${isEditable ? `
                        <div class="edit-buttons">
                            ${!isEditing ? `
                                <button onclick="editStudent('${student.student_id}')" class="btn btn-edit">Quick Edit</button>
                                <a href="profile.html?id=${student.student_id}" class="btn btn-view">Full Profile</a>
                            ` : ''}
                        </div>
                        
                        <div class="edit-form ${isEditing ? 'active' : ''}" id="edit-form-${student.student_id}">
                            <h4>Edit Your Profile</h4>
                            <input type="text" id="edit-name-${student.student_id}" placeholder="Full Name" value="${student.full_name || ''}">
                            <input type="email" id="edit-email-${student.student_id}" placeholder="Email" value="${student.email || ''}">
                            <input type="tel" id="edit-phone-${student.student_id}" placeholder="Phone Number" value="${student.phone_number || ''}">
                            <div class="edit-buttons">
                                <button onclick="saveStudent('${student.student_id}')" class="btn btn-save">Save Changes</button>
                                <button onclick="cancelEdit('${student.student_id}')" class="btn btn-cancel">Cancel</button>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                studentGrid.appendChild(cardDiv);
            });
        }

        // Edit student
        function editStudent(studentId) {
            editingStates[studentId] = true;
            displayStudents();
        }

        // Cancel edit
        function cancelEdit(studentId) {
            delete editingStates[studentId];
            displayStudents();
            showMessage('Edit cancelled', 'info');
        }

        // Save student - FIXED VERSION WITH PROPER RLS HANDLING
        async function saveStudent(studentId) {
            if (!currentUser) {
                showMessage('You must be logged in to edit profiles', 'error');
                return;
            }

            const student = students.find(s => s.student_id === studentId);
            if (!student) {
                showMessage('Student not found', 'error');
                return;
            }

            // Check if user owns this profile
            if (currentUser.student_id !== studentId) {
                showMessage('You can only edit your own profile', 'error');
                return;
            }

            const updatedData = {
                full_name: document.getElementById(`edit-name-${studentId}`).value.trim(),
                email: document.getElementById(`edit-email-${studentId}`).value.trim(),
                phone_number: document.getElementById(`edit-phone-${studentId}`).value.trim(),
                updated_at: new Date().toISOString()
            };

            // Validate required fields
            if (!updatedData.full_name) {
                showMessage('Name is required', 'error');
                return;
            }

            if (!updatedData.email) {
                showMessage('Email is required', 'error');
                return;
            }

            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(updatedData.email)) {
                showMessage('Please enter a valid email address', 'error');
                return;
            }

            try {
                console.log('Updating student profile:', { studentId, updatedData });

                // Update using user_id for RLS compliance
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .update(updatedData)
                    .eq('user_id', currentUser.id)  // Use user_id for RLS
                    .eq('student_id', studentId)    // Double check student_id
                    .select()
                    .single();

                if (error) {
                    console.error('Update error:', error);
                    
                    if (error.message.includes('row-level security policy')) {
                        throw new Error('You do not have permission to edit this profile');
                    }
                    
                    throw new Error('Failed to update profile: ' + error.message);
                }

                console.log('Profile updated successfully:', data);

                // Update local data
                const studentIndex = students.findIndex(s => s.student_id === studentId);
                if (studentIndex !== -1) {
                    students[studentIndex] = { ...students[studentIndex], ...updatedData };
                }

                delete editingStates[studentId];
                displayStudents();
                showMessage('Profile updated successfully!', 'success');

            } catch (error) {
                console.error('Error updating profile:', error);
                showMessage(error.message, 'error');
            }
        }

        // Show message
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageClass = type === 'success' ? 'success-message' : 
                               type === 'error' ? 'error-message' : 'info-message';
            
            messagesDiv.innerHTML = `<div class="${messageClass}">${message}</div>`;
            
            // Clear message after 5 seconds
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 5000);
        }

        // Initialize page
        async function initializePage() {
            console.log('Initializing batch page...');
            await checkCurrentUser();
            await loadStudents();
        }

        // Listen for auth state changes
        supabaseClient.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                setTimeout(() => {
                    initializePage();
                }, 100);
            }
        });

        // Start the page
        initializePage();
    </script>
