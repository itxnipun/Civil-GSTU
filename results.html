<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Results</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- You can adjust these styles -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #student-info {
      background: #3498db;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    #results-container {
      width: 90%;
      max-width: 900px;
      margin: 2rem auto;
    }
    .accordion-button {
      background: #34495e;
      color: white;
      cursor: pointer;
      padding: 1rem;
      width: 100%;
      text-align: left;
      border: none;
      outline: none;
      transition: background 0.3s;
      margin-top: 0.5rem;
      border-radius: 6px;
    }
    .accordion-button:hover {
      background: #2c3e50;
    }
    .accordion-content {
      background: white;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
      padding: 0 1rem;
      border-radius: 0 0 6px 6px;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    .results-table th, .results-table td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    .results-table th {
      background: #2980b9;
      color: white;
    }
    .gpa-summary {
      text-align: right;
      font-weight: bold;
      margin: 0.5rem 0 1rem;
    }
    #cgpa-summary {
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      margin: 2rem;
      color: #2c3e50;
    }
  </style>
</head>
<body>
  <header>
    <h1>Results</h1>
  </header>

  <!-- Profile header -->
  <div id="student-info">
    <h2>Loading Profile...</h2>
  </div>

  <!-- Container for results -->
  <div id="results-container">
    <!-- Accordion buttons for 8 semesters -->
    <button class="accordion-button">Level 1 Term 1</button>
    <div class="accordion-content" id="l1t1-content"></div>

    <button class="accordion-button">Level 1 Term 2</button>
    <div class="accordion-content" id="l1t2-content"></div>

    <button class="accordion-button">Level 2 Term 1</button>
    <div class="accordion-content" id="l2t1-content"></div>

    <button class="accordion-button">Level 2 Term 2</button>
    <div class="accordion-content" id="l2t2-content"></div>

    <button class="accordion-button">Level 3 Term 1</button>
    <div class="accordion-content" id="l3t1-content"></div>

    <button class="accordion-button">Level 3 Term 2</button>
    <div class="accordion-content" id="l3t2-content"></div>

    <button class="accordion-button">Level 4 Term 1</button>
    <div class="accordion-content" id="l4t1-content"></div>

    <button class="accordion-button">Level 4 Term 2</button>
    <div class="accordion-content" id="l4t2-content"></div>
  </div>

  <div id="cgpa-summary">CGPA: --</div>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <!-- Your auth + guard scripts -->
  <script src="auth.js"></script>
  <script src="auth-guard.js"></script>

  <!-- Results logic -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const studentInfoEl = document.getElementById('student-info');
      const cgpaSummaryEl = document.getElementById('cgpa-summary');

      try {
        // 1) Ensure logged in
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) throw new Error("Not logged in");

        // 2) Fetch profile (works with id OR user_id)
        const { data: profile, error: profileError } = await supabaseClient
          .from('profiles')
          .select('student_id, full_name')
          .or(`id.eq.${session.user.id},user_id.eq.${session.user.id}`)
          .single();

        if (profileError || !profile) {
          studentInfoEl.innerHTML = `<h2>Error loading profile</h2>`;
          throw new Error("Profile not found");
        }

        // 3) Show profile header
        studentInfoEl.innerHTML = `
          <h2>${profile.full_name}</h2>
          <p>Student ID: ${profile.student_id}</p>
        `;

        // 4) Fetch results (match DB column names)
        const { data: results, error: resultsError } = await supabaseClient
          .from('results')
          .select('level, term, course_code, course_title, credit_hours, letter_grade, grade_point')
          .eq('student_id', profile.student_id)
          .order('level')
          .order('term');

        // Debugging: Log what is returned
        console.log("[results] fetched results:", results);
        console.log("[results] error fetching results:", resultsError);

        if (resultsError) throw resultsError;

        if (!results || results.length === 0) {
          document.getElementById('results-container').innerHTML = `
            <div style="text-align:center;padding:2rem;">
              <h3>No Results Available</h3>
              <p>Please check back later.</p>
            </div>
          `;
          return;
        }

        // 5) Group results by level+term
        const grouped = results.reduce((acc, r) => {
          const key = `l${r.level}t${r.term}`;
          (acc[key] ||= []).push(r);
          return acc;
        }, {});

        let totalCredits = 0;
        let totalWeighted = 0;

        // 6) Render each term
        for (const key in grouped) {
          const rows = grouped[key];
          const panel = document.getElementById(`${key}-content`);
          if (!panel) continue;

          let termCredits = 0;
          let termWeighted = 0;

          let tableHTML = `
            <table class="results-table">
              <thead>
                <tr>
                  <th>Course Code</th>
                  <th>Course Title</th>
                  <th>Credit</th>
                  <th>Grade</th>
                  <th>Grade Points</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (const r of rows) {
            const cr = Number(r.credit_hours) || 0;
            const gp = Number(r.grade_point) || 0;

            termCredits += cr;
            termWeighted += gp * cr;

            tableHTML += `
              <tr>
                <td>${r.course_code}</td>
                <td>${r.course_title}</td>
                <td>${cr}</td>
                <td>${r.letter_grade ?? ''}</td>
                <td>${gp.toFixed(2)}</td>
              </tr>
            `;
          }

          tableHTML += `</tbody></table>`;

          const termGPA = termCredits ? (termWeighted / termCredits) : 0;
          panel.innerHTML = `
            ${tableHTML}
            <div class="gpa-summary">Term GPA: ${termGPA.toFixed(2)}</div>
          `;

          totalCredits += termCredits;
          totalWeighted += termWeighted;
        }

        // 7) Show overall CGPA
        const cgpa = totalCredits ? (totalWeighted / totalCredits) : 0;
        cgpaSummaryEl.textContent = `CGPA: ${cgpa.toFixed(2)}`;

        // 8) Accordion toggle
        document.querySelectorAll('.accordion-button').forEach((btn) => {
          btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            const panel = btn.nextElementSibling;
            if (panel.style.maxHeight) {
              panel.style.maxHeight = null;
            } else {
              panel.style.maxHeight = panel.scrollHeight + "px";
            }
          });
        });

      } catch (err) {
        console.error("Error loading results:", err);
      }
    });
  </script>
</body>
</html>
